<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êº¢Â≠ó„Çø„ÉØ„Éº„Éá„Ç£„Éï„Çß„É≥„Çπ„ÄåÊñáÂ≠óÂüéÈò≤Ë°õ„Äç</title>
    <meta name="description" content="Êº¢Â≠ó„ÅÆË™≠„Åø„ÇíÁ≠î„Åà„Å¶Êïµ„ÇíÊíÉÈÄÄ„Åô„ÇãÊïôËÇ≤ÁöÑ„Çø„ÉØ„Éº„Éá„Ç£„Éï„Çß„É≥„Çπ„Ç≤„Éº„É†„ÄÇÊïµ„ÅåÁîªÈù¢‰∏ä„ÅßÂüé„Å´Âêë„Åã„Å£„Å¶ÈÄ≤Ëªç„Åó„ÄÅ„É™„Ç¢„É´„Çø„Ç§„É†„ÅßÊà¶Áï•ÁöÑ„Å´Èò≤Ë°õ„Åô„ÇãÊú¨Ê†ºÁöÑ„Å™„Ç≤„Éº„É†‰ΩìÈ®ì„ÄÇ">
    <meta name="keywords" content="Êº¢Â≠ó,„Çø„ÉØ„Éº„Éá„Ç£„Éï„Çß„É≥„Çπ,Â≠¶Áøí„Ç≤„Éº„É†,ÊïôËÇ≤,Â∞èÂ≠¶Áîü,‰∏≠Â≠¶Áîü,Êó•Êú¨Ë™ûÂ≠¶Áøí">
    <meta name="robots" content="index, follow">
    <meta name="author" content="AppADayCreator">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://appadaycreator.github.io/kanji-tower-defense/">
    <meta property="og:title" content="Êº¢Â≠ó„Çø„ÉØ„Éº„Éá„Ç£„Éï„Çß„É≥„Çπ„ÄåÊñáÂ≠óÂüéÈò≤Ë°õ„Äç">
    <meta property="og:description" content="Êº¢Â≠ó„ÅÆË™≠„Åø„ÇíÁ≠î„Åà„Å¶Êïµ„ÇíÊíÉÈÄÄ„Åô„ÇãÊïôËÇ≤ÁöÑ„Çø„ÉØ„Éº„Éá„Ç£„Éï„Çß„É≥„Çπ„Ç≤„Éº„É†">
    <meta property="og:image" content="https://appadaycreator.github.io/kanji-tower-defense/og-image.png">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://appadaycreator.github.io/kanji-tower-defense/">
    <meta property="twitter:title" content="Êº¢Â≠ó„Çø„ÉØ„Éº„Éá„Ç£„Éï„Çß„É≥„Çπ„ÄåÊñáÂ≠óÂüéÈò≤Ë°õ„Äç">
    <meta property="twitter:description" content="Êº¢Â≠ó„ÅÆË™≠„Åø„ÇíÁ≠î„Åà„Å¶Êïµ„ÇíÊíÉÈÄÄ„Åô„ÇãÊïôËÇ≤ÁöÑ„Çø„ÉØ„Éº„Éá„Ç£„Éï„Çß„É≥„Çπ„Ç≤„Éº„É†">
    <meta property="twitter:image" content="https://appadaycreator.github.io/kanji-tower-defense/og-image.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèØ</text></svg>">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi5ryi5a2X44K/44Ov44O844OH44Kj44OV44Kn44Oz44K544CM5paH5a2X5Z+O6Ziy6KGBUEQiLCJzaG9ydF9uYW1lIjoi5paH5a2X5Z+O6Ziy6KGBIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiMzMzY2Y2MiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLDxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCc+PHRleHQgeT0nLjllbScgZm9udC1zaXplPSc5MCc+8J+PrzwvdGV4dD48L3N2Zz4iLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TXQGZRF9');</script>
    
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Orbitron:wght@400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow-x: hidden;
        }
        
        .game-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .game-title {
            font-family: 'Orbitron', monospace;
            background: linear-gradient(45deg, #ff6b6b, #ffd93d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .game-board {
            background: linear-gradient(45deg, #1a1a2e, #16213e);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }
        
        .game-board::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 107, 107, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 217, 61, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }
        
        #gameCanvas {
            border: 3px solid #4a5568;
            border-radius: 15px;
            background: #2d3748;
            display: block;
            margin: 0 auto;
            cursor: crosshair;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #51cf66, #40c057);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(81, 207, 102, 0.4);
        }
        
        .game-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #fff;
            font-family: 'Orbitron', monospace;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #cbd5e0;
            margin-top: 5px;
        }
        
        .kanji-input-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .kanji-display {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .current-kanji {
            font-size: 4rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .kanji-info {
            font-size: 1.1rem;
            color: #4a5568;
            margin-bottom: 15px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .kanji-input {
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 500;
            background: white;
            transition: all 0.3s ease;
            min-width: 200px;
        }
        
        .kanji-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .level-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .level-btn {
            padding: 8px 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .level-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-color: #667eea;
        }
        
        .level-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
        }
        
        .settings-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .settings-label {
            color: #cbd5e0;
            font-weight: 500;
        }
        
        .font-size-controls {
            display: flex;
            gap: 5px;
        }
        
        .font-size-btn {
            padding: 5px 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }
        
        .font-size-btn.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }
        
        .message-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(45deg, #51cf66, #40c057);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .message-display.show {
            transform: translateX(0);
        }
        
        .message-display.error {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
        }
        
        .game-over-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .game-over-modal.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            color: white;
            max-width: 400px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .game-over-modal.show .modal-content {
            transform: scale(1);
        }
        
        .modal-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 20px;
            font-family: 'Orbitron', monospace;
        }
        
        .modal-stats {
            margin-bottom: 30px;
        }
        
        .modal-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        @media (max-width: 768px) {
            .game-title {
                font-size: 1.8rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                justify-content: center;
            }
            
            .current-kanji {
                font-size: 3rem;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .kanji-input {
                min-width: 100%;
            }
        }
        
        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes enemyHit {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        @keyframes towerShoot {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes correctAnswer {
            0% { background-color: #51cf66; }
            100% { background-color: transparent; }
        }
        
        @keyframes wrongAnswer {
            0% { background-color: #ff6b6b; }
            100% { background-color: transparent; }
        }
        
        .hit-animation {
            animation: enemyHit 0.3s ease;
        }
        
        .shoot-animation {
            animation: towerShoot 0.2s ease;
        }
        
        .correct-animation {
            animation: correctAnswer 0.5s ease;
        }
        
        .wrong-animation {
            animation: wrongAnswer 0.5s ease;
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TXQGZRF9"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    
    <div class="game-container">
        <h1 class="game-title">üèØ Êº¢Â≠ó„Çø„ÉØ„Éº„Éá„Ç£„Éï„Çß„É≥„Çπ„ÄåÊñáÂ≠óÂüéÈò≤Ë°õ„Äç</h1>
        
        <div class="game-board">
            <!-- Ë®≠ÂÆö„Éë„Éç„É´ -->
            <div class="settings-panel">
                <div class="settings-row">
                    <span class="settings-label">üî§ ÊñáÂ≠ó„Çµ„Ç§„Ç∫ / Font Size:</span>
                    <div class="font-size-controls">
                        <button class="font-size-btn" onclick="setFontSize('xs')">Ê•µÂ∞è</button>
                        <button class="font-size-btn" onclick="setFontSize('sm')">Â∞è</button>
                        <button class="font-size-btn active" onclick="setFontSize('md')">Ê®ôÊ∫ñ</button>
                        <button class="font-size-btn" onclick="setFontSize('lg')">Â§ß</button>
                        <button class="font-size-btn" onclick="setFontSize('xl')">ÁâπÂ§ß</button>
                    </div>
                </div>
            </div>
            
            <!-- „É¨„Éô„É´ÈÅ∏Êäû -->
            <div class="level-selector">
                <button class="level-btn active" onclick="setLevel('grade1')">Â∞èÂ≠¶1Âπ¥Áîü</button>
                <button class="level-btn" onclick="setLevel('grade2')">Â∞èÂ≠¶2Âπ¥Áîü</button>
                <button class="level-btn" onclick="setLevel('grade3')">Â∞èÂ≠¶3Âπ¥Áîü</button>
                <button class="level-btn" onclick="setLevel('grade4')">Â∞èÂ≠¶4Âπ¥Áîü</button>
                <button class="level-btn" onclick="setLevel('grade5')">Â∞èÂ≠¶5Âπ¥Áîü</button>
                <button class="level-btn" onclick="setLevel('grade6')">Â∞èÂ≠¶6Âπ¥Áîü</button>
                <button class="level-btn" onclick="setLevel('middle')">‰∏≠Â≠¶Áîü</button>
                <button class="level-btn" onclick="setLevel('common')">Â∏∏Áî®Êº¢Â≠ó</button>
                <button class="level-btn" onclick="setLevel('nando')">Èõ£Ë™≠</button>
            </div>
            
            <!-- „Ç≤„Éº„É†Áµ±Ë®à -->
            <div class="game-stats">
                <div class="stat-card">
                    <div class="stat-value" id="waveDisplay">1</div>
                    <div class="stat-label">„Ç¶„Çß„Éº„Éñ / Wave</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="scoreDisplay">0</div>
                    <div class="stat-label">„Çπ„Ç≥„Ç¢ / Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="goldDisplay">100</div>
                    <div class="stat-label">„Ç¥„Éº„É´„Éâ / Gold</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="hpDisplay">100</div>
                    <div class="stat-label">ÂüéHP / Castle HP</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="accuracyDisplay">100%</div>
                    <div class="stat-label">Ê≠£Á≠îÁéá / Accuracy</div>
                </div>
            </div>
            
            <!-- „Ç≥„É≥„Éà„É≠„Éº„É´ -->
            <div class="controls">
                <div class="control-group">
                    <button class="btn btn-primary" onclick="startGame()">üéÆ „Ç≤„Éº„É†ÈñãÂßã</button>
                    <button class="btn btn-secondary" onclick="pauseGame()">‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢</button>
                    <button class="btn btn-secondary" onclick="resetGame()">üîÑ „É™„Çª„ÉÉ„Éà</button>
                </div>
                <div class="control-group">
                    <button class="btn btn-success" onclick="showHint()">üí° „Éí„É≥„Éà</button>
                    <button class="btn btn-success" onclick="shareResult()">üì§ ÁµêÊûúÂÖ±Êúâ</button>
                </div>
            </div>
            
            <!-- Êº¢Â≠óÂÖ•Âäõ„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="kanji-input-section">
                <div class="kanji-display">
                    <div class="current-kanji" id="currentKanji">Ê∫ñÂÇô‰∏≠...</div>
                    <div class="kanji-info" id="kanjiInfo">„Ç≤„Éº„É†„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
                </div>
                <div class="input-group">
                    <input type="text" class="kanji-input" id="kanjiInput" placeholder="Êº¢Â≠ó„ÅÆË™≠„Åø„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ" disabled>
                    <button class="btn btn-success" onclick="checkAnswer()">‚ö° ÊîªÊíÉ</button>
                </div>
            </div>
            
            <!-- „Ç≤„Éº„É†„Ç≠„É£„É≥„Éê„Çπ -->
            <canvas id="gameCanvas" width="800" height="600"></canvas>
        </div>
    </div>
    
    <!-- „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ -->
    <div id="messageDisplay" class="message-display"></div>
    
    <!-- „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„É¢„Éº„ÉÄ„É´ -->
    <div id="gameOverModal" class="game-over-modal">
        <div class="modal-content">
            <h2 class="modal-title">üèÜ „Ç≤„Éº„É†ÁµÇ‰∫Ü</h2>
            <div class="modal-stats">
                <div class="modal-stat">
                    <span>ÊúÄÁµÇ„Çπ„Ç≥„Ç¢:</span>
                    <span id="finalScore">0</span>
                </div>
                <div class="modal-stat">
                    <span>Âà∞ÈÅî„Ç¶„Çß„Éº„Éñ:</span>
                    <span id="finalWave">1</span>
                </div>
                <div class="modal-stat">
                    <span>Ê≠£Á≠îÁéá:</span>
                    <span id="finalAccuracy">100%</span>
                </div>
                <div class="modal-stat">
                    <span>ÊíÉÁ†¥Êï∞:</span>
                    <span id="finalKills">0</span>
                </div>
            </div>
            <button class="btn btn-primary" onclick="restartGame()">üîÑ „ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§</button>
            <button class="btn btn-success" onclick="shareResult()">üì§ ÁµêÊûú„Çí„Ç∑„Çß„Ç¢</button>
        </div>
    </div>
    
    <script type="module">
        import { kanjiDatabase } from './words.js';

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let canvas, ctx;
        let gameState = {
            isPlaying: false,
            isPaused: false,
            wave: 1,
            score: 0,
            gold: 100,
            castleHP: 100,
            maxHP: 100,
            accuracy: 100,
            correctAnswers: 0,
            totalAnswers: 0,
            kills: 0,
            level: 'grade1',
            fontSize: 'md'
        };
        
        let enemies = [];
        let towers = [];
        let bullets = [];
        let particles = [];
        let currentEnemy = null;
        let gameLoop;
        let waveTimer = 0;
        let spawnTimer = 0;
        
        // „Éë„ÇπÂÆöÁæ©ÔºàÊïµ„ÅÆÈÄ≤Ë°å„É´„Éº„ÉàÔºâ
        const gamePath = [
            {x: 0, y: 300},
            {x: 150, y: 300},
            {x: 150, y: 150},
            {x: 350, y: 150},
            {x: 350, y: 450},
            {x: 550, y: 450},
            {x: 550, y: 300},
            {x: 800, y: 300}
        ];
        
        // ÂàùÊúüÂåñ
        function init() {
            console.log('üéÆ „Ç≤„Éº„É†ÂàùÊúüÂåñÈñãÂßã');
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // „Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫„ÇíÂãïÁöÑ„Å´Ë™øÊï¥
            resizeCanvas();
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
            canvas.addEventListener('click', handleCanvasClick);
            document.getElementById('kanjiInput').addEventListener('keypress', handleKeyPress);
            window.addEventListener('resize', resizeCanvas);
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„ÇâË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
            loadSettings();
            
            // „Ç≤„Éº„É†„É´„Éº„ÉóÈñãÂßã
            gameLoop = setInterval(update, 1000/60); // 60FPS
            
            // ÂàùÊúüÊèèÁîª
            drawGame();
            
            console.log('‚úÖ „Ç≤„Éº„É†ÂàùÊúüÂåñÂÆå‰∫Ü');
        }
        
        // „Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫Ë™øÊï¥
        function resizeCanvas() {
            const container = canvas.parentElement;
            const maxWidth = Math.min(container.offsetWidth - 40, 800);
            const maxHeight = Math.min(window.innerHeight * 0.6, 600);
            
            canvas.width = maxWidth;
            canvas.height = maxHeight;
            
            // „Éë„Çπ„ÇíÁîªÈù¢„Çµ„Ç§„Ç∫„Å´Âêà„Çè„Åõ„Å¶Ë™øÊï¥
            updatePathForSize(maxWidth, maxHeight);
        }
        
        // „Éë„Çπ„Çµ„Ç§„Ç∫Ë™øÊï¥
        function updatePathForSize(width, height) {
            const scaleX = width / 800;
            const scaleY = height / 600;
            
            gamePath.forEach(point => {
                point.x = Math.min(point.x * scaleX, width - 50);
                point.y = Math.min(point.y * scaleY, height - 50);
            });
        }
        
        // „Ç≤„Éº„É†ÈñãÂßã
        function startGame() {
            console.log('üéÆ „Ç≤„Éº„É†ÈñãÂßã');
            gameState.isPlaying = true;
            gameState.isPaused = false;
            document.getElementById('kanjiInput').disabled = false;
            
            // ÊúÄÂàù„ÅÆÊïµ„ÇíÁîüÊàê
            spawnEnemy();
            
            showMessage('„Ç≤„Éº„É†ÈñãÂßãÔºÅÊïµ„ÇíÊíÉÈÄÄ„Åó„Çà„ÅÜÔºÅ', 'success');
            updateDisplay();
        }
        
        // „Ç≤„Éº„É†‰∏ÄÊôÇÂÅúÊ≠¢
        function pauseGame() {
            console.log('‚è∏Ô∏è „Ç≤„Éº„É†‰∏ÄÊôÇÂÅúÊ≠¢');
            gameState.isPaused = !gameState.isPaused;
            showMessage(gameState.isPaused ? '„Ç≤„Éº„É†‰∏ÄÊôÇÂÅúÊ≠¢' : '„Ç≤„Éº„É†ÂÜçÈñã', 'info');
        }
        
        // „Ç≤„Éº„É†„É™„Çª„ÉÉ„Éà
        function resetGame() {
            console.log('üîÑ „Ç≤„Éº„É†„É™„Çª„ÉÉ„Éà');
            gameState = {
                isPlaying: false,
                isPaused: false,
                wave: 1,
                score: 0,
                gold: 100,
                castleHP: 100,
                maxHP: 100,
                accuracy: 100,
                correctAnswers: 0,
                totalAnswers: 0,
                kills: 0,
                level: gameState.level,
                fontSize: gameState.fontSize
            };
            
            enemies = [];
            towers = [];
            bullets = [];
            particles = [];
            currentEnemy = null;
            waveTimer = 0;
            spawnTimer = 0;
            
            document.getElementById('kanjiInput').disabled = true;
            document.getElementById('kanjiInput').value = '';
            document.getElementById('currentKanji').textContent = 'Ê∫ñÂÇô‰∏≠...';
            document.getElementById('kanjiInfo').textContent = '„Ç≤„Éº„É†„ÇíÈñãÂßã„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            
            updateDisplay();
            drawGame();
            
            showMessage('„Ç≤„Éº„É†„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü', 'info');
        }
        
        // ÊïµÁîüÊàê
        function spawnEnemy() {
            const kanjiData = getRandomKanji();
            const enemy = {
                id: Date.now(),
                x: gamePath[0].x,
                y: gamePath[0].y,
                pathIndex: 0,
                kanji: kanjiData.kanji,
                reading: kanjiData.reading,
                meaning: kanjiData.meaning,
                hp: 100,
                maxHP: 100,
                speed: 1 + (gameState.wave * 0.1),
                color: getRandomColor(),
                size: 30
            };
            
            enemies.push(enemy);
            
            // ÁèæÂú®„ÅÆÊïµ„Å®„Åó„Å¶Ë®≠ÂÆö
            if (!currentEnemy) {
                setCurrentEnemy(enemy);
            }
            
            console.log(`üëπ ÊïµÁîüÊàê: ${enemy.kanji} (${enemy.reading})`);
        }
        
        // ÁèæÂú®„ÅÆÊïµË®≠ÂÆö
        function setCurrentEnemy(enemy) {
            currentEnemy = enemy;
            document.getElementById('currentKanji').textContent = enemy.kanji;
            document.getElementById('kanjiInfo').textContent = `${enemy.meaning} „ÅÆË™≠„ÅøÊñπ„ÅØÔºü`;
            document.getElementById('kanjiInput').value = '';
            document.getElementById('kanjiInput').focus();
        }
        
        // „É©„É≥„ÉÄ„É†Êº¢Â≠óÂèñÂæó
        function getRandomKanji() {
            const levelData = kanjiDatabase[gameState.level];
            return levelData[Math.floor(Math.random() * levelData.length)];
        }
        
        // „É©„É≥„ÉÄ„É†Ëâ≤ÂèñÂæó
        function getRandomColor() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dda0dd', '#98d8c8'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // „Çø„ÉØ„ÉºË®≠ÁΩÆ
        function placeTower(x, y) {
            if (gameState.gold >= 50) {
                const tower = {
                    x: x,
                    y: y,
                    range: 100,
                    damage: 25,
                    fireRate: 60, // „Éï„É¨„Éº„É†Êï∞
                    lastFire: 0,
                    color: '#ffd93d'
                };
                
                towers.push(tower);
                gameState.gold -= 50;
                
                console.log(`üè∞ „Çø„ÉØ„ÉºË®≠ÁΩÆ: (${x}, ${y})`);
                showMessage('„Çø„ÉØ„Éº„ÇíË®≠ÁΩÆ„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                updateDisplay();
            } else {
                showMessage('„Ç¥„Éº„É´„Éâ„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ', 'error');
            }
        }
        
        // Á≠î„Åà„ÉÅ„Çß„ÉÉ„ÇØ
        function checkAnswer() {
            const input = document.getElementById('kanjiInput').value.trim();
            if (!input || !currentEnemy) return;
            
            console.log(`üéØ Á≠î„Åà„ÉÅ„Çß„ÉÉ„ÇØ: "${input}" vs "${currentEnemy.reading}"`);
            
            gameState.totalAnswers++;
            
            if (input === currentEnemy.reading) {
                // Ê≠£Ëß£
                gameState.correctAnswers++;
                gameState.score += 100;
                gameState.gold += 20;
                gameState.kills++;
                
                // Êïµ„ÇíÂÄí„Åô
                const enemyIndex = enemies.indexOf(currentEnemy);
                if (enemyIndex > -1) {
                    enemies.splice(enemyIndex, 1);
                }
                
                // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÂäπÊûú
                createParticles(currentEnemy.x, currentEnemy.y, '#51cf66');
                
                // Ê¨°„ÅÆÊïµ„ÇíË®≠ÂÆö
                if (enemies.length > 0) {
                    setCurrentEnemy(enemies[0]);
                } else {
                    currentEnemy = null;
                    document.getElementById('currentKanji').textContent = 'Ê∫ñÂÇô‰∏≠...';
                    document.getElementById('kanjiInfo').textContent = 'Ê¨°„ÅÆÊïµ„ÇíÂæÖÊ©ü‰∏≠...';
                }
                
                showMessage('Ê≠£Ëß£ÔºÅÊïµ„ÇíÂÄí„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                
                // Ê≠£Ëß£„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                document.getElementById('kanjiInput').classList.add('correct-animation');
                setTimeout(() => {
                    document.getElementById('kanjiInput').classList.remove('correct-animation');
                }, 500);
                
            } else {
                // ‰∏çÊ≠£Ëß£
                currentEnemy.hp -= 25;
                showMessage(`‰∏çÊ≠£Ëß£ÔºÅÊ≠£Ëß£„ÅØ„Äå${currentEnemy.reading}„Äç„Åß„Åô`, 'error');
                
                // ‰∏çÊ≠£Ëß£„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                document.getElementById('kanjiInput').classList.add('wrong-animation');
                setTimeout(() => {
                    document.getElementById('kanjiInput').classList.remove('wrong-animation');
                }, 500);
            }
            
            // Á≤æÂ∫¶Êõ¥Êñ∞
            gameState.accuracy = Math.round((gameState.correctAnswers / gameState.totalAnswers) * 100);
            
            document.getElementById('kanjiInput').value = '';
            updateDisplay();
        }
        
        // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÁîüÊàê
        function createParticles(x, y, color) {
            for (let i = 0; i < 10; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    color: color,
                    life: 30,
                    maxLife: 30
                });
            }
        }
        
        // „É°„Ç§„É≥„Ç≤„Éº„É†„É´„Éº„Éó
        function update() {
            if (!gameState.isPlaying || gameState.isPaused) return;
            
            // Êïµ„ÅÆÊõ¥Êñ∞
            updateEnemies();
            
            // „Çø„ÉØ„Éº„ÅÆÊõ¥Êñ∞
            updateTowers();
            
            // Âºæ‰∏∏„ÅÆÊõ¥Êñ∞
            updateBullets();
            
            // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÅÆÊõ¥Êñ∞
            updateParticles();
            
            // Êïµ„ÅÆ„Çπ„Éù„Éº„É≥
            spawnTimer++;
            if (spawnTimer > 120 && enemies.length < 3) { // 2ÁßíÈñìÈöî„ÅßÊúÄÂ§ß3‰Ωì
                spawnEnemy();
                spawnTimer = 0;
            }
            
            // „Ç¶„Çß„Éº„ÉñÁÆ°ÁêÜ
            waveTimer++;
            if (waveTimer > 1800) { // 30Áßí„Åß„Ç¶„Çß„Éº„ÉñÊõ¥Êñ∞
                gameState.wave++;
                waveTimer = 0;
                showMessage(`„Ç¶„Çß„Éº„Éñ ${gameState.wave} ÈñãÂßãÔºÅ`, 'info');
            }
            
            // „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº„ÉÅ„Çß„ÉÉ„ÇØ
            if (gameState.castleHP <= 0) {
                gameOver();
            }
            
            // ÊèèÁîª
            drawGame();
            
            // Ë°®Á§∫Êõ¥Êñ∞
            updateDisplay();
        }
        
        // Êïµ„ÅÆÊõ¥Êñ∞
        function updateEnemies() {
            enemies.forEach((enemy, index) => {
                if (enemy.pathIndex < gamePath.length - 1) {
                    // Ê¨°„ÅÆ„Éù„Ç§„É≥„Éà„Å´Âêë„Åã„Å£„Å¶ÁßªÂãï
                    const targetPoint = gamePath[enemy.pathIndex + 1];
                    const dx = targetPoint.x - enemy.x;
                    const dy = targetPoint.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < enemy.speed) {
                        enemy.pathIndex++;
                        enemy.x = targetPoint.x;
                        enemy.y = targetPoint.y;
                    } else {
                        enemy.x += (dx / distance) * enemy.speed;
                        enemy.y += (dy / distance) * enemy.speed;
                    }
                } else {
                    // Âüé„Å´Âà∞ÈÅî
                    gameState.castleHP -= 10;
                    enemies.splice(index, 1);
                    
                    if (enemy === currentEnemy) {
                        if (enemies.length > 0) {
                            setCurrentEnemy(enemies[0]);
                        } else {
                            currentEnemy = null;
                            document.getElementById('currentKanji').textContent = 'Ê∫ñÂÇô‰∏≠...';
                            document.getElementById('kanjiInfo').textContent = 'Ê¨°„ÅÆÊïµ„ÇíÂæÖÊ©ü‰∏≠...';
                        }
                    }
                    
                    showMessage('Êïµ„ÅåÂüé„Å´Âà∞ÈÅîÔºÅHP„ÅåÊ∏õÂ∞ëÔºÅ', 'error');
                }
                
                // Ê≠ª‰∫°„ÉÅ„Çß„ÉÉ„ÇØ
                if (enemy.hp <= 0) {
                    enemies.splice(index, 1);
                    gameState.score += 50;
                    gameState.kills++;
                    
                    if (enemy === currentEnemy) {
                        if (enemies.length > 0) {
                            setCurrentEnemy(enemies[0]);
                        } else {
                            currentEnemy = null;
                            document.getElementById('currentKanji').textContent = 'Ê∫ñÂÇô‰∏≠...';
                            document.getElementById('kanjiInfo').textContent = 'Ê¨°„ÅÆÊïµ„ÇíÂæÖÊ©ü‰∏≠...';
                        }
                    }
                    
                    createParticles(enemy.x, enemy.y, '#ff6b6b');
                }
            });
        }
        
        // „Çø„ÉØ„Éº„ÅÆÊõ¥Êñ∞
        function updateTowers() {
            towers.forEach(tower => {
                tower.lastFire++;
                
                if (tower.lastFire >= tower.fireRate) {
                    // ÁØÑÂõ≤ÂÜÖ„ÅÆÊïµ„ÇíÊé¢„Åô
                    const target = enemies.find(enemy => {
                        const dx = enemy.x - tower.x;
                        const dy = enemy.y - tower.y;
                        return Math.sqrt(dx * dx + dy * dy) <= tower.range;
                    });
                    
                    if (target) {
                        // Âºæ‰∏∏Áô∫Â∞Ñ
                        bullets.push({
                            x: tower.x,
                            y: tower.y,
                            targetX: target.x,
                            targetY: target.y,
                            speed: 5,
                            damage: tower.damage,
                            target: target
                        });
                        
                        tower.lastFire = 0;
                        
                        // Â∞ÑÊíÉ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
                        tower.shooting = true;
                        setTimeout(() => {
                            tower.shooting = false;
                        }, 200);
                    }
                }
            });
        }
        
        // Âºæ‰∏∏„ÅÆÊõ¥Êñ∞
        function updateBullets() {
            bullets.forEach((bullet, index) => {
                const dx = bullet.targetX - bullet.x;
                const dy = bullet.targetY - bullet.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < bullet.speed || distance < 5) {
                    // Âºæ‰∏∏„ÅåÁõÆÊ®ô„Å´Âà∞ÈÅî
                    if (bullet.target && enemies.includes(bullet.target)) {
                        bullet.target.hp -= bullet.damage;
                        createParticles(bullet.target.x, bullet.target.y, '#ffd93d');
                    }
                    bullets.splice(index, 1);
                } else {
                    // Âºæ‰∏∏„ÇíÁßªÂãï
                    bullet.x += (dx / distance) * bullet.speed;
                    bullet.y += (dy / distance) * bullet.speed;
                }
            });
        }
        
        // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´„ÅÆÊõ¥Êñ∞
        function updateParticles() {
            particles.forEach((particle, index) => {
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.life--;
                
                if (particle.life <= 0) {
                    particles.splice(index, 1);
                }
            });
        }
        
        // „Ç≤„Éº„É†ÊèèÁîª
        function drawGame() {
            // ËÉåÊôØ„ÇØ„É™„Ç¢
            ctx.fillStyle = '#2d3748';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // „Éë„ÇπÊèèÁîª
            drawPath();
            
            // ÂüéÊèèÁîª
            drawCastle();
            
            // „Çø„ÉØ„ÉºÊèèÁîª
            drawTowers();
            
            // ÊïµÊèèÁîª
            drawEnemies();
            
            // Âºæ‰∏∏ÊèèÁîª
            drawBullets();
            
            // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÊèèÁîª
            drawParticles();
            
            // UIË¶ÅÁ¥†ÊèèÁîª
            drawUI();
        }
        
        // „Éë„ÇπÊèèÁîª
        function drawPath() {
            ctx.strokeStyle = '#4a5568';
            ctx.lineWidth = 20;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            ctx.beginPath();
            ctx.moveTo(gamePath[0].x, gamePath[0].y);
            
            for (let i = 1; i < gamePath.length; i++) {
                ctx.lineTo(gamePath[i].x, gamePath[i].y);
            }
            
            ctx.stroke();
        }
        
        // ÂüéÊèèÁîª
        function drawCastle() {
            const castle = gamePath[gamePath.length - 1];
            
            // Âüé„ÅÆÊú¨‰Ωì
            ctx.fillStyle = '#8b5cf6';
            ctx.fillRect(castle.x - 25, castle.y - 25, 50, 50);
            
            // Âüé„ÅÆË©≥Á¥∞
            ctx.fillStyle = '#a855f7';
            ctx.fillRect(castle.x - 15, castle.y - 35, 30, 20);
            
            // Âüé„ÅÆÊóó
            ctx.fillStyle = '#f59e0b';
            ctx.fillRect(castle.x - 5, castle.y - 40, 10, 15);
            
            // HP „Éê„Éº
            const hpRatio = gameState.castleHP / gameState.maxHP;
            ctx.fillStyle = '#ef4444';
            ctx.fillRect(castle.x - 30, castle.y - 45, 60, 8);
            ctx.fillStyle = '#10b981';
            ctx.fillRect(castle.x - 30, castle.y - 45, 60 * hpRatio, 8);
        }
        
        // „Çø„ÉØ„ÉºÊèèÁîª
        function drawTowers() {
            towers.forEach(tower => {
                // „Çø„ÉØ„Éº„ÅÆÁØÑÂõ≤ÔºàËñÑ„ÅèË°®Á§∫Ôºâ
                ctx.strokeStyle = 'rgba(255, 217, 61, 0.2)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(tower.x, tower.y, tower.range, 0, Math.PI * 2);
                ctx.stroke();
                
                // „Çø„ÉØ„ÉºÊú¨‰Ωì
                ctx.fillStyle = tower.shooting ? '#f59e0b' : tower.color;
                ctx.beginPath();
                ctx.arc(tower.x, tower.y, 15, 0, Math.PI * 2);
                ctx.fill();
                
                // „Çø„ÉØ„Éº„ÅÆË©≥Á¥∞
                ctx.fillStyle = '#1f2937';
                ctx.beginPath();
                ctx.arc(tower.x, tower.y, 8, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        // ÊïµÊèèÁîª
        function drawEnemies() {
            enemies.forEach(enemy => {
                // Êïµ„ÅÆÊú¨‰Ωì
                ctx.fillStyle = enemy.color;
                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y, enemy.size, 0, Math.PI * 2);
                ctx.fill();
                
                // Êïµ„ÅÆÊº¢Â≠ó
                ctx.fillStyle = '#fff';
                ctx.font = '20px "Noto Sans JP"';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(enemy.kanji, enemy.x, enemy.y);
                
                // HP „Éê„Éº
                const hpRatio = enemy.hp / enemy.maxHP;
                ctx.fillStyle = '#ef4444';
                ctx.fillRect(enemy.x - 20, enemy.y - 35, 40, 6);
                ctx.fillStyle = '#10b981';
                ctx.fillRect(enemy.x - 20, enemy.y - 35, 40 * hpRatio, 6);
                
                // ÁèæÂú®„ÅÆÊïµ„ÅÆ„Éè„Ç§„É©„Ç§„Éà
                if (enemy === currentEnemy) {
                    ctx.strokeStyle = '#fbbf24';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(enemy.x, enemy.y, enemy.size + 5, 0, Math.PI * 2);
                    ctx.stroke();
                }
            });
        }
        
        // Âºæ‰∏∏ÊèèÁîª
        function drawBullets() {
            bullets.forEach(bullet => {
                ctx.fillStyle = '#fbbf24';
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, 5, 0, Math.PI * 2);
                ctx.fill();
                
                // Âºæ‰∏∏„ÅÆËªåË∑°
                ctx.strokeStyle = 'rgba(251, 191, 36, 0.5)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(bullet.x, bullet.y);
                ctx.lineTo(bullet.x - bullet.speed, bullet.y - bullet.speed);
                ctx.stroke();
            });
        }
        
        // „Éë„Éº„ÉÜ„Ç£„ÇØ„É´ÊèèÁîª
        function drawParticles() {
            particles.forEach(particle => {
                const alpha = particle.life / particle.maxLife;
                ctx.fillStyle = particle.color + Math.floor(alpha * 255).toString(16).padStart(2, '0');
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        // UIÊèèÁîª
        function drawUI() {
            // „Ç∞„É™„ÉÉ„ÉâÔºà„Çø„ÉØ„ÉºË®≠ÁΩÆÁî®Ôºâ
            if (gameState.isPlaying) {
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.lineWidth = 1;
                
                for (let x = 0; x < canvas.width; x += 40) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                
                for (let y = 0; y < canvas.height; y += 40) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
            }
        }
        
        // „Ç≠„É£„É≥„Éê„Çπ„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜ
        function handleCanvasClick(event) {
            if (!gameState.isPlaying) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            // „Çø„ÉØ„ÉºË®≠ÁΩÆ‰ΩçÁΩÆ„ÅÆË™øÊï¥
            const gridX = Math.floor(x / 40) * 40 + 20;
            const gridY = Math.floor(y / 40) * 40 + 20;
            
            // „Éë„Çπ‰∏ä„Åß„Å™„Åë„Çå„Å∞„Çø„ÉØ„ÉºË®≠ÁΩÆ
            if (!isOnPath(gridX, gridY)) {
                placeTower(gridX, gridY);
            }
        }
        
        // „Éë„Çπ‰∏ä„ÉÅ„Çß„ÉÉ„ÇØ
        function isOnPath(x, y) {
            for (let i = 0; i < gamePath.length - 1; i++) {
                const start = gamePath[i];
                const end = gamePath[i + 1];
                
                const distance = distanceToLineSegment(x, y, start.x, start.y, end.x, end.y);
                if (distance < 30) return true;
            }
            return false;
        }
        
        // Á∑öÂàÜ„Å®„ÅÆË∑ùÈõ¢Ë®àÁÆó
        function distanceToLineSegment(px, py, x1, y1, x2, y2) {
            const dx = x2 - x1;
            const dy = y2 - y1;
            const length = Math.sqrt(dx * dx + dy * dy);
            
            if (length === 0) return Math.sqrt((px - x1) * (px - x1) + (py - y1) * (py - y1));
            
            const t = Math.max(0, Math.min(1, ((px - x1) * dx + (py - y1) * dy) / (length * length)));
            const projection = {
                x: x1 + t * dx,
                y: y1 + t * dy
            };
            
            return Math.sqrt((px - projection.x) * (px - projection.x) + (py - projection.y) * (py - projection.y));
        }
        
        // „Ç≠„ÉºÂÖ•ÂäõÂá¶ÁêÜ
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                checkAnswer();
            }
        }
        
        // Ë°®Á§∫Êõ¥Êñ∞
        function updateDisplay() {
            document.getElementById('waveDisplay').textContent = gameState.wave;
            document.getElementById('scoreDisplay').textContent = gameState.score;
            document.getElementById('goldDisplay').textContent = gameState.gold;
            document.getElementById('hpDisplay').textContent = gameState.castleHP;
            document.getElementById('accuracyDisplay').textContent = gameState.accuracy + '%';
        }
        
        // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
        function showMessage(message, type = 'info') {
            const messageDiv = document.getElementById('messageDisplay');
            messageDiv.textContent = message;
            messageDiv.className = `message-display ${type}`;
            messageDiv.classList.add('show');
            
            setTimeout(() => {
                messageDiv.classList.remove('show');
            }, 3000);
        }
        
        // „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº
        function gameOver() {
            console.log('üíÄ „Ç≤„Éº„É†„Ç™„Éº„Éê„Éº');
            gameState.isPlaying = false;
            
            // ÊúÄÁµÇÁµêÊûú„ÇíË°®Á§∫
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('finalWave').textContent = gameState.wave;
            document.getElementById('finalAccuracy').textContent = gameState.accuracy + '%';
            document.getElementById('finalKills').textContent = gameState.kills;
            
            // „É¢„Éº„ÉÄ„É´Ë°®Á§∫
            document.getElementById('gameOverModal').classList.add('show');
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´Ë®òÈå≤
            saveGameRecord();
        }
        
        // „Ç≤„Éº„É†ÂÜçÈñã
        function restartGame() {
            document.getElementById('gameOverModal').classList.remove('show');
            resetGame();
        }
        
        // „Ç≤„Éº„É†Ë®òÈå≤‰øùÂ≠ò
        function saveGameRecord() {
            const record = {
                score: gameState.score,
                wave: gameState.wave,
                accuracy: gameState.accuracy,
                kills: gameState.kills,
                level: gameState.level,
                date: new Date().toISOString()
            };
            
            let records = JSON.parse(localStorage.getItem('kanjiTowerDefenseRecords') || '[]');
            records.push(record);
            records.sort((a, b) => b.score - a.score); // „Çπ„Ç≥„Ç¢È†Ü„Åß„ÇΩ„Éº„Éà
            records = records.slice(0, 10); // ‰∏ä‰Ωç10‰ª∂„ÅÆ„Åø‰øùÊåÅ
            
            localStorage.setItem('kanjiTowerDefenseRecords', JSON.stringify(records));
        }
        
        // Ë®≠ÂÆöË™≠„ÅøËæº„Åø
        function loadSettings() {
            const savedSettings = localStorage.getItem('kanjiTowerDefenseSettings');
            if (savedSettings) {
                const settings = JSON.parse(savedSettings);
                gameState.fontSize = settings.fontSize || 'md';
                gameState.level = settings.level || 'grade1';
                
                // UIÊõ¥Êñ∞
                setFontSize(gameState.fontSize);
                setLevel(gameState.level);
            }
        }
        
        // Ë®≠ÂÆö‰øùÂ≠ò
        function saveSettings() {
            const settings = {
                fontSize: gameState.fontSize,
                level: gameState.level
            };
            localStorage.setItem('kanjiTowerDefenseSettings', JSON.stringify(settings));
        }
        
        // „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫Ë®≠ÂÆö
        function setFontSize(size) {
            gameState.fontSize = size;
            // „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÇØ„É©„Çπ„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.font-size-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // event.target„Ååundefined„ÅÆÂ†¥Âêà„Å´ÂÇô„Åà„ÄÅÊòéÁ§∫ÁöÑ„Å´„Éú„Çø„É≥„ÇíÂèñÂæó
            const btn = document.querySelector(`.font-size-btn[onclick*="setFontSize('${size}')"]`);
            if (btn) btn.classList.add('active');
            // CSSÂ§âÊï∞„Åß„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÇíË™øÊï¥
            const fontSizes = {
                xs: '0.75rem',
                sm: '0.875rem',
                md: '1rem',
                lg: '1.125rem',
                xl: '1.25rem'
            };
            document.documentElement.style.setProperty('--font-size', fontSizes[size]);
            saveSettings();
        }
        
        // „É¨„Éô„É´Ë®≠ÂÆö
        function setLevel(level) {
            gameState.level = level;
            
            // „É¨„Éô„É´„Éú„Çø„É≥„ÇíÊõ¥Êñ∞
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            saveSettings();
        }
        
        // „Éí„É≥„ÉàË°®Á§∫
        function showHint() {
            if (currentEnemy) {
                const hint = `„Éí„É≥„Éà: ${currentEnemy.meaning} (${currentEnemy.kanji})`;
                showMessage(hint, 'info');
            } else {
                showMessage('ÁèæÂú®ÂØæË±°„ÅÆÊïµ„Åå„ÅÑ„Åæ„Åõ„Çì', 'info');
            }
        }
        
        // ÁµêÊûúÂÖ±Êúâ
        function shareResult() {
            const text = `üèØ Êº¢Â≠ó„Çø„ÉØ„Éº„Éá„Ç£„Éï„Çß„É≥„Çπ„ÄåÊñáÂ≠óÂüéÈò≤Ë°õ„Äç\n\nüìä ÁµêÊûú:\n` +
                         `„Çπ„Ç≥„Ç¢: ${gameState.score}\n` +
                         `„Ç¶„Çß„Éº„Éñ: ${gameState.wave}\n` +
                         `Ê≠£Á≠îÁéá: ${gameState.accuracy}%\n` +
                         `ÊíÉÁ†¥Êï∞: ${gameState.kills}\n\n` +
                         `#Êº¢Â≠ó„Ç≤„Éº„É† #Â≠¶Áøí„Ç≤„Éº„É† #„Çø„ÉØ„Éº„Éá„Ç£„Éï„Çß„É≥„Çπ\n` +
                         `https://appadaycreator.github.io/kanji-tower-defense/`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Êº¢Â≠ó„Çø„ÉØ„Éº„Éá„Ç£„Éï„Çß„É≥„Çπ„ÄåÊñáÂ≠óÂüéÈò≤Ë°õ„Äç',
                    text: text,
                    url: 'https://appadaycreator.github.io/kanji-tower-defense/'
                });
            } else {
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
                navigator.clipboard.writeText(text).then(() => {
                    showMessage('ÁµêÊûú„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ', 'success');
                }).catch(() => {
                    showMessage('ÂÖ±Êúâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error');
                });
            }
        }
        
        // PWAÂØæÂøú
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered');
                    })
                    .catch(error => {
                        console.log('‚ùå Service Worker registration failed');
                    });
            });
        }
        
        // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„ÅÆÂàùÊúüÂåñ
        window.addEventListener('load', init);
        
        // „Éö„Éº„Ç∏„É™„Çµ„Ç§„Ç∫ÊôÇ„ÅÆÂá¶ÁêÜ
        window.addEventListener('resize', () => {
            setTimeout(resizeCanvas, 100);
        });
        
        // „Éá„Éê„ÉÉ„Ç∞Áî®„Ç≥„É≥„ÇΩ„Éº„É´Âá∫Âäõ
        console.log('üéÆ Êº¢Â≠ó„Çø„ÉØ„Éº„Éá„Ç£„Éï„Çß„É≥„Çπ„ÄåÊñáÂ≠óÂüéÈò≤Ë°õ„Äç Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
        console.log('üì± PWAÂØæÂøúÊ∏à„Åø');
        console.log('üéØ „Ç≤„Éº„É†Ê©üËÉΩ: „Çø„ÉØ„ÉºË®≠ÁΩÆ„ÄÅÊïµ„ÅÆÁßªÂãï„ÄÅÊº¢Â≠óÂÖ•Âäõ„ÄÅÁµ±Ë®àÁÆ°ÁêÜ');
        console.log('üîß ÊäÄË°ì‰ªïÊßò: HTML5 Canvas, „É¨„Çπ„Éù„É≥„Ç∑„Éñ„Éá„Ç∂„Ç§„É≥, „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏');
        
    </script>
</body>
</html>